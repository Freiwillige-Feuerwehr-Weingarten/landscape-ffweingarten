---
- name: Setup wireguard server
  hosts: test_wireguard
  remote_user: ffweingarten
  become: true
  become_user: root
  vars:
    server_privkey: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32313131366439313433653365636232316437396633316236333862383462643861303931623064
          6566663765343365386365663463313763333238663663330a666639333363613634316564656462
          33643930393965653939316535633766653037353866376239313739323836356265643435303737
          6632373865313961330a386439643333333265353131383335393631656262336263363130666265
          61656366666238363736363761373936323837336130373932653234613662376665323233393166
          6162353233623461633761353238613932376131646263366338
    server_pubkey: FtZTtzS4Gta27xaTfNiZRivMRRSc4exPqrok3zclSn8=
  roles:
    - role: common
      vars:
        setup_qemu: false
    - role: devsec.hardening.ssh_hardening
      sftp_enabled: true
    - role: devsec.hardening.os_hardening
      vars:
        sysctl_overwrite:
          net.ipv4.ip_forward: 1
        os_security_packages_clean: false
    - role: wireguard
    - role: tribe29.checkmk.agent
      vars:
        checkmk_agent_edition: cre
        checkmk_agent_protocol: http
        checkmk_agent_server: checkmk.test.feuerwehr.weingarten.local
        checkmk_agent_server_validate_certs: 'true'
        checkmk_agent_version: "2.1.0p22"
        checkmk_agent_site: "feuerwehr"
        chechmk_agent_user: "automation"
        checkmk_agent_secret: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          35363333653164383466363532336336393630653565636534663036316535666338346132336466
          6134623065386136316233616636333936326130333836660a613838393534656332633365646461
          65383236316264326533393739303436646432306662353233393231616432656532323439656261
          3239306331396665650a373339326537666435623266396237613361393830646430353431353335
          37343135656538313730306435646239326161643336386238303636623366303361
        checkmk_agent_registration_server: "{{ checkmk_agent_server }}"
        checkmk_agent_registration_site: "{{ checkmk_agent_site }}"
        checkmk_agent_folder: "/"
        checkmk_agent_tls: 'true'
        checkmk_agent_add_host: 'true'
        checkmk_agent_discover: 'true'
        checkmk_agent_force_install: 'true'
        checkmk_agent_delegate_api_calls: localhost
        checkmk_agent_delegate_download: "{{ inventory_hostname }}"
        checkmk_agent_host_name: "{{ inventory_hostname }}"
        checkmk_agent_update: 'true'
        checkmk_agent_host_attributes:
          ipaddress: "{{ checkmk_agent_host_ip | default(omit) }}"
